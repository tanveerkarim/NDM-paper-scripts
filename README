This text file documents scripts used to produce results reported in the NDM selection method paper (2018). It also details scripts and their results not reported in the paper but documented here for reproducibility and complete update on the status of the method. 

Contents: I group scripts and their results according to topic.
- Organization
- Software requirements
- utils and NDM_models modules
- Data download and acquisition
- Data pre-processing
- Data quality checks

README convention (for the author):
- "/----" to denote the beginning of a new grouping or section. 
- Five "\n" between sections.
- Use only "-" for lists.





/---- Organization
To orient the user of this document, I provide a high level overview of the documentation of the project. Here is the directory structure
/NDM-paper
	/article
	/data
		/derived
	/scripts
	/notes

- "article" contains the manuscript .tex file and all other immediate relevant packages, figures, bibliography, etc. 
- "data" contains all primary data files used for the project. Any derived data products such as cross-matched catalogs are stored in "data/derived" directory. 
- "scripts" contains all Python scripts used to produce any results.
- "notes" are a collection of text files that summarize important results that are not included in the NDM paper.





/---- Software requirements
Unless mentioned otherwise, the work contained here is based on Python 2.7.12. Below is a non-exhaustive list of key packages used: 
- numpy v1.9.1
- astropy v1.1.1
- scipy v0.19.0
- extreme-deconvolution-1.4: https://github.com/jobovy/extreme-deconvolution

The rest is based on Python 3.5.2. In particular, an application of Random Forest (RF) method to DEEP2-DECaLS DR5 data is performed using the following package compatible with Python 3.5.2:
- scikit-learn v0.19.1

These are not stringent requirements, and there is no reason to believe that other compatible versions of Python would produce different results.





/---- utils and NDM_models
All author defined functions are collected in utils and NDM_models. The latter is a collection of classes and methods that are specific to the NDM method whereas the former provides general convenience functions. For convenience, I employ the bad practice of importing all external modules, functions, and classes at the same time via "from utils, NDM_models import *". 





/---- Data download and acquisition
In this section, I document how key data for the project were obtained. All of these data are available via a single download from (provide URL) or can be obtained from the author in a .zip file. 

- DEEP2 photometric catalogs: Downloaded from the DEEP2 survey website using below commands.
wget http://deep.ps.uci.edu/DR4/data/pcat_ext.21.fits.gz
wget http://deep.ps.uci.edu/DR4/data/pcat_ext.22.fits.gz
wget http://deep.ps.uci.edu/DR4/data/pcat_ext.31.fits.gz
wget http://deep.ps.uci.edu/DR4/data/pcat_ext.32.fits.gz
wget http://deep.ps.uci.edu/DR4/data/pcat_ext.33.fits.gz
wget http://deep.ps.uci.edu/DR4/data/pcat_ext.41.fits.gz
wget http://deep.ps.uci.edu/DR4/data/pcat_ext.42.fits.gz
wget http://deep.ps.uci.edu/DR4/data/pcat_ext.43.fits.gz

- DEEP2 window functions: Downloaded from the DEEP2 survey website using below commands.
wget http://deep.ps.uci.edu/DR4/data/windowf.21.fits.gz
wget http://deep.ps.uci.edu/DR4/data/windowf.22.fits.gz
wget http://deep.ps.uci.edu/DR4/data/windowf.31.fits.gz
wget http://deep.ps.uci.edu/DR4/data/windowf.32.fits.gz
wget http://deep.ps.uci.edu/DR4/data/windowf.33.fits.gz
wget http://deep.ps.uci.edu/DR4/data/windowf.41.fits.gz
wget http://deep.ps.uci.edu/DR4/data/windowf.42.fits.gz

- DEEP2 redshift catalogs: These were obtained from John Moustakas and are described in a Tech Report (DESI docDB-912). The redshift catalogs from Fields 2, 3, and 4 are named deep2-f2-redz-oii.fits, deep2-f3-redz-oii.fits, and deep2-f4-redz-oii.fits in the data repository.

- DEEP2 color selection: The file is a union list of DEEP2 photometric catalogs with an additional information regarding color selection. It was obtained from Jeff Newman and named color-selection.txt in the data repository. See "Cross-matching..." section scripts for description.

- survey-bricks-dr5: A useful file that can be used to determine Tractor bricks that cover regions of interest. Downloaded using the below command.
wget http://portal.nersc.gov/project/cosmo/data/legacysurvey/dr5/survey-bricks-dr5.fits.gz

- DR5 Tractor catalogs in DEEP2 Fields 2, 3, and 4: Using the "bricks" file above and a short script (generate-tractor-download-scripts.py), the below download scripts were generated:
tractor-download-d2f2.sh
tractor-download-d2f3.sh
tractor-download-d2f4.sh

- Tycho-2 catalog: The file was obtained from one of the DESI collaborators though I cannot remember whom. Named tycho2.fits in the data repostiory.

- spitzer catalogs: (add further description)





/---- Data pre-processing
After downloading/acquiring the DECaLS DR5 and DEEP2 catalogs, they are pre-processed into convenient forms as described in this section.

Combine all downloaded Tractor files by DEEP2 Field
- Notes: Combine all Tractor files by Field, append Tycho-2 stellar mask column, and mask objects using DEEP2 window funtions. Note that no other catalog quality cuts were made at this point. Tycho-2 masks were appended but not imposed as may be altered in the future.
- Script used: combine-Tractor-bricks.py
- Products:
	- DR5-Tractor-D2f*.fits

Combine DEEP2 catalogs
- Notes: Combine photometric and redshift catalogs (by matching the two and appending select columns from redshift catalogs to photometric catalogs). DEEP2 window functions are applied and Tycho-2 mask column is applied to the objects. For more information, please see produce-deep2-f234-photo-redz-oii-prints.txt. Refer to generate_class_col function for the exact classification scheme used.
- Script used: produce-deep2-f234-photo-redz-oii.py
- Products: 
	- deep2-f**-photo-trimmed.fits: Intermediate products after applying DEEP2 window mask and BADFLAG quality cut. Consult the code.
	- deep2-f**-photo-redz-oii.fits: Final products of the combined DEEP2 photometric and redshift catalogs.

Combine DEEP2 and DR5
- Notes: We make the following cuts prior to cross matching.
	- Common: Tycho mask and window function.
	- DR5: g < 24.25, grz_allmask == 0, grz_ivar > 0, brick_primary == 0.
	grz_all mask might be too stringent but this is done for convenience. This condition may be loosened down the road. We match DEEP2 catalogs onto DR5. Please refer to combine-Tractor-DEEP2-prints.txt
- Script used: combine-Tractor-DEEP2.py
- Products:
	- unmatched-deep2-f**-photo-redz-oii.fits
	- DR5-matched-to-DEEP2-f**-glim24p25.fits



Intersection set area calculation

Definition of asinh magnitude


/---- Data quality checks
After pre-processing the data into convenient forms, we perform sanity checks on the data quality.

DEEP2 raw and weighted number comparison
- Notes: Based on the combined DEEP2 photometric and redshift catalogs, the weighted total number using DEEP2 target probability must be comparable to the raw total number in each Field. 

DEEP2 ELG properties comparison by Field
- Notes: Based on the combined DEEP2 photometric and redshift catalogs, the target probability weighted properties of ELG in the three Fields must be comparable. Compare the following quantities: number density, redshift distribution, OII distribution, BRI-magnitude distribution.

DECaLS DR5 number density comparison by Field
- Notes: Based on combined DECaLS DR5 catalogs only, the following quantities should be comparable given g < 24.25: grz-magnitude distribution and total number density.

DEEP2-DECaLS DR5 intersection set (g < 24.25)
- Notes: The properties of the intersection set in different Fields should be comparable to each other: grz-magnitude distribution, grz-color distributions, total number density, redshift distribution, and OII distribution. Both weighted and unweighted should be compared. Division by class.

DECaLS DR5 unmatched to DEEP2 set
- Notes: Confirm that the unmatched set has the same grz-color-magnitude distribution as the matched set.

RADEC Plots of DEEP2, DECaLS, and Intersection sets.



/----- Note on DEEP2 and DR5 Venn Diagram -----/
- We only consider objects within DEEP2 windown function and Tycho-2 masked set. We match DEEP2 pcats in its entirety with DR5 with g < 25.
- Ideally, DEEP2 pcat is deep and complete enough to include all objects in DR5, say, down to g < 25. 
- In both DR5 and DEEP2: These are used to model the number densities of ELG and non-ELG. (Rlim = 24.1 does not matter.)
- In DR5 g < 25 but not in DEEP2: About 6 percent in Field 4: We may 1) categorize them as non-ELG and hence to be avoided; or 2) ignore them while training but re-scale the total number density after training the density models to account for them.
- In DEEP2 set but not in DR5: For the purpose of modeling, let's not worry about characterizing these objects. It may be possible to improve DESI cataloging process by looking at why certain bright objects observed in DEEP2 were not observed in Tractor but we do not pursue that.


/----- GMM training -----/
- Make sure to hand cut outliers before training.
- When fitting in magnitude space, objects that have very poor colors (say due to negative flux values) should be avoided.
